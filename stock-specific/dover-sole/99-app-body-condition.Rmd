---
title:
  "DRAFT CONDITION APPENDIX"
date: "2025-07-28"
output:
 csasdown::manureport_word:
   french: false
   
bibliography: refs.bib
header-includes:
  -  \usepackage{bm}
---

```{r set-stock-params, echo = FALSE, cache = FALSE, message = FALSE, results = 'hide', warning = FALSE}
# copy file to spp folder and select species, prefix for density models, and year-month of analysis to be reported
# check comments within text sections for needed updates
species <- "Dover Sole"
stock_name <- "Dover Sole"
dens_model_name0 <- "dln-"
model_date <- "2025-07"
knot_distance <- "20" # current default
```


```{r setup, echo=FALSE, cache=FALSE, message=FALSE, results='hide', warning=FALSE}
# set options that roughly match csasdown ones for compatibility when full assessment is done with csasdown
library(knitr)
options(knitr.graphics.error = FALSE) # required for knitting to word
fig_out_type <- "png"
fig_asp <- 0.618
fig_width <- 9
fig_out_width <- "6in"
fig_dpi <- 180
fig_align <- "center"
fig_pos <- "htb"
opts_chunk$set(
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  comment = "#>",
  fig.asp = fig_asp,
  fig.width = fig_width,
  out.width = fig_out_width,
  echo = FALSE,
  cache.comments = FALSE,
  dev = fig_out_type,
  dpi = fig_dpi,
  fig.align = fig_align,
  fig.pos = fig_pos
)
```

```{r load-libraries, echo = FALSE, cache = FALSE, message = FALSE, results = 'hide', warning = FALSE}
library(dplyr)
library(readr)
library(tibble)
library(csasdown)
```

```{r get-model-data, echo = FALSE, cache = FALSE, message = FALSE, results = 'hide', warning = FALSE}
# spp <- gsub(" ", "-", gsub("\\/", "-", tolower(species)))
spp <- gsub(" ", "-", gsub("\\/", "-", tolower(stock_name)))

itest <- readRDS(here::here(paste0("stock-specific/",spp,"/output/compare-models/",spp,"-relative-to-", dens_model_name0, model_date, 
                                   "-", knot_distance, "-km.rds")))
dens_model_name <- itest[itest$total_diff==min(itest$total_diff),]$model_string

m <- readRDS(paste0("stock-specific/", spp, "/output/density-models/", dens_model_name,
                    "/mat-fem/", spp, "-mat-fem-", dens_model_name, 
                    "-", knot_distance, "-km.rds"))

year_range <- range(m$data$year)
survey_types <- unique(m$data$survey_type)

mc <- readRDS(paste0("stock-specific/", spp, "/output/condition-models/", model_date, "/", spp, "-c-mat-fem-", model_date, "-", knot_distance, "-km.rds"))
mc2 <- readRDS(paste0("stock-specific/", spp, "/output/condition-models/", model_date, "/", spp, "-c-mat-m-", model_date, "-", knot_distance, "-km.rds"))
mc3 <- readRDS(paste0("stock-specific/", spp, "/output/condition-models/", model_date, "/", spp, "-c-imm-", model_date, "-", knot_distance, "-km.rds"))

mc_data <- bind_rows(mc$data, 
                     mc2$data, 
                     mc3$data)

rm(mc,mc2,mc3)

unique(mc_data$survey_abbrev) # original names
unique(mc_data$survey_group) # factor levels for condition models
unique(mc_data$survey_type) # factor levels for density models

mssm_min <- min(mc_data[mc_data$survey_abbrev %in% c("MSSM WCVI", "MSSM QCS"),]$year)
msa_min <- min(mc_data[mc_data$survey_type == "MSA",]$year)

thorny_years <- length(unique(mc_data[mc_data$survey_abbrev %in% c("THORNYHEAD"),]$year))
```


# SEX AND MATURITY SPECIFIC INDICES OF BODY CONDITION

Because the condition of mature male, mature female (SSB in this assessment), and immature individuals have different implications for population dynamics, observation error characteristics, and potentially even different ecological drivers, we first separated individuals and overall catches into immatures, mature males and mature females. 
We then estimated independent spatiotemporal biomass distributions, calculated individual Le Cren’s relative body condition deviations, modelled spatiotemporal change in these deviations, and generated a density-weighted annual index of average condition for each component of the population. 

## SPLITTING SPECIMENS AND TOTAL CATCH BY SEX AND MATURITY

To maximize the sample size and spatiotemporal representation, we used morphological measurements collected from all fishery-independent surveys, and total catch weights from all surveys that had positive catches in at least three years and at least 1% positive catches overall between `r year_range[1]` and `r year_range[2]` (Figure \@ref(fig:sample-year-hist)). 

<!-- < fig 1 > -->
```{r sample-year-hist, echo=FALSE, fig.align='center', fig.pos='h', out.width="6in", fig.cap="Distribution of years by survey for specimens included in the body condition analyses."}
knitr::include_graphics(here::here(paste0("stock-specific/",spp,"/figs/C-sample-year-hist.png")))
```

<!-- Update to include only the survey types used and describe more fully any not included elsewhere in assessment. -->
Surveys included for density estimation were the four contemporary Synoptic bottom trawl surveys (SYN; described in Appendix \@ref(app:survey)), 
two Small-mesh Multispecies Bottom Trawl Surveys (SMMS; described in Appendix \@ref(app:survey)), 
the Hecate Strait Multispecies Assemblage Survey (MSA; described in Appendix \@ref(app:survey)),
NOAA's Triennial Survey when it entered Canadian waters (TRIENNIAL; described in Appendix \@ref(app:survey)), 
and two more targeted trawl surveys--the west coast Vancouver Island thornyhead and Hecate Strait Pacific Cod surveys.
Of these, the SYN, SMMS, MSA and THORNYHEAD surveys collected morphological data for `r species` (Figure \@ref(fig:sample-year-hist)).
Protocols for collecting individual-level data varied between surveys and with the size of catches, but generally included sampling from the larger catches up to a maximum of 50 individuals per tow. 

The Hecate Strait Pacific Cod (*Gadus macrocephalus*) survey (HS PCOD) targeted known hotspots for this species annually for three years [2002-2004, @sinclair2002]. The depths sampled ranged from 22 to 168~m. Abundance data was collected for all groundfish species encountered, but morphological data was collected only for a couple target species. 

The West Coast Vancouver Island Thornyhead Bottom Trawl (THORNYHEAD) used a stratified random design targeting depths between 500 and 1600~m annually for three years [2001-2003, @starr2002; @krishka2005]. 

The SMMS surveys target shrimp and have been conducted off the west coast of Vancouver Island in most years since 1975 and in Queen Charlotte Sound between 1998 and 2016, but `r species` morphological measurements were only collected starting in `r mssm_min`. This survey currently follows a fixed station design covering depths mostly between 50 and 200 m, but it has undergone some changes since its inception [@dunic2025]. We account for a protocol change in 2003 and a gear change in 2006 by including different catchabilities before and after these changes in our species distribution models. 

The MSA was conducted mostly biennially between 1984 and 2003, but `r species` morphological measurements were only collected starting in `r msa_min`.

<!-- The integrated acoustic-trawl surveys (HAKE) targeting Pacific Hake (*Merluccius productus*), which have been conducted in Canadian waters since 1977 \citep{deblois2020}, also collected sufficient morphological data for `r species` in `r unique(mc_data[mc_data$survey_abbrev %in% c("HAKE"),]$year)`. -->
<!-- This survey uses echosounders to detect likely schools of Pacific Hake and then tows a net to sample these schools for species and size composition.  -->
<!-- Overall, tows from the Hake survey are sparse across much of the coast in most years, but lengths, and sometimes weights, were taken from all rockfish and any species that was dominant in the catch composition.  -->

We assigned individual fish to maturity classes based on the average length at 50% maturity estimated with set ID as a random intercept:

<!-- < eqn 1 > -->
$$
\begin{aligned}
    M_i &\sim \operatorname{Bernoulli} \left( p_i \right),\\
    p_i &= \operatorname{logit}^{-1} \left( \alpha + \alpha_{t} + \beta L_i \right),\\
    \alpha_t &\sim
  \operatorname{Normal}  \left(0, \sigma^2_{\alpha} \right),
\end{aligned}
$$


where $M_i$ represents the mature ($1$) or immature ($0$) status of fish $i$, $p_i$ represents the probability of maturity of fish $i$, $\alpha$ represents a global intercept, $\alpha_t$ represents a set-level deviation $t$ that is allowed to vary with a variance of $\sigma_\alpha^2$, $\beta$ represents a coefficient, and $L_i$ represents the length of fish $i$.
The result was that males larger than 58.5 cm were deemed mature and females above 68.5 cm (Figure \@ref(fig:maturity)). 

<!-- < fig 2 > -->
```{r maturity, echo=FALSE, fig.align='center', fig.pos='h', out.width="5in", fig.cap="Length at maturity ogives and thresholds used to spilt individuals into immature vs. mature classes for females (solid lines) and males (dashed lines). Faint background ogives represent random effect estimates for each set ID."}
knitr::include_graphics(here::here(paste0("stock-specific/",spp,"/figs/C-maturity.png")))
# knitr::include_graphics("figs/C-01-maturity.png")
```

When individual weights were missing, but lengths were known, individuals were assigned estimated weights based on the overall average length-weight relationship (derived using Eq. \@ref(eq:lw-student); Figure \@ref(fig:length-weight-all)).
<!-- In past have refered to biological appendix of stock assessment, although could be added here too for completeness. -->

For each sampled tow, we then split the total catch of each species into immature, mature males, and mature females using the observed proportions by weight among the individually measured specimens. 
<!-- Only include this next sentence when dens_model_name does not include "only-sampled" -->
For unsampled tows in all survey-year combinations with at least six sampled tows, we applied the average proportion of each category from all sampled tows in that survey-year. 
We excluded any survey-year combinations with less than six tows.

## SPATIOTEMPORAL ESTIMATES OF BIOMASS DENSITY

In order to calculate a weighted-average body condition and account for possible density-dependence, we needed spatiotemporal estimates of biomass density for each maturity class. 
We fit separate spatiotemporal models for the estimated split catches representing relative catch weights of immatures, mature males, mature females, and all classes combined. 

We used a delta (hurdle) approach [@aitchison1955] with a Bernoulli distribution for presence-absence (technically detection-non-detection) and a lognormal distribution for the positive catches. 
We modelled survey catch weights as representative of relative biomass density $D$ for point in space $s$ and time $t$ as a product of two component models, 

<!-- < eqn 2 > -->
$$
\begin{aligned}
\operatorname{D_{s,t}} \sim \operatorname{Bernoulli} \left( \mu_{1,s,t} \right) \cdot \operatorname{lognormal} \left(\operatorname{log} \mu_{2,s,t} - \frac{\vartheta^{2}}{2},\vartheta^2 \right),
\end{aligned}
$$

where $\mu_{1,s,t}$ represents the expected probability of catching the species in a given tow and $\mu_{2,s,t}$ represents the expected biomass density conditional on a positive observation when $\vartheta$ is the standard deviation of positive observations in log-space.
These two components were modelled as a function of a series of fixed and random effects:

<!-- < eqn 3 > -->
$$
\begin{aligned}
  \mu_{1,s,t} &= \operatorname{logit}^{-1} 
    \left(\alpha_1 + X_{1,s,t} \beta_1 + \omega_{1,s} + \epsilon_{1,s,t}\right),\\
\mu_{2,s,t} &= \exp 
    \left(\alpha_2 + X_{2,s,t} \beta_2 + \omega_{2,s} + \epsilon_{2,s,t}\right),
\end{aligned}
$$

where $\alpha$ represents the intercept for synoptic trawl surveys, $X_{s,t}$ represents a vector of predictors (factors for other survey types, and second order orthogonal polynomials of log depth and day-of-year relative to the summer solstice), and $\beta$ represents a vector of corresponding parameters.
The subscripts 1 and 2 denote the equivalent parameters from the first (Bernoulli) and second (lognormal) linear predictors.

We constrained the covariance via a Matérn covariance function with the range (distance at which correlation is effectively independent) being allowed to differ between the spatial and spatiotemporal fields. 
Each symbol $\omega_s$ represents spatially correlated random effects (a random field) that are constant through time, which are assumed to follow a multivariate normal distribution with covariance matrix $\Sigma_\omega$:

<!-- < eqn 4 > -->
$$
\begin{aligned}
\omega_{s} &\sim \operatorname{MVNormal} \left( 0, \Sigma_{\omega } \right),
\end{aligned}
$$

Each $\epsilon_{s,t}$ term represents annual spatially correlated random effects that were similarly constrained as a GMRF with inverse precision matrix $\bm{\Sigma}_{\epsilon}$, and where the $\bm{\epsilon}_t$ are assumed to follow a random-walk process given by:

<!-- < eqn 5 > -->
$$
\begin{aligned}
 \bm{\delta_{t}} &\sim \operatorname{MVNormal} \left( \bm{0}, \bm{\bm{\Sigma}}_{\epsilon} \right),\\
 \bm{\epsilon}_{t=1} &= \bm{\delta}_{t=1},\\
 \bm{\epsilon}_{t>1} &= \bm{\epsilon}_{t-1} + \bm{\delta_{t}}.
\end{aligned}
$$

We included all tows that sampled for a distance > 500 m (or at least 10 min at a speed of at least 50 mpm).
These values were combined with net opening to estimate the area swept [e.g., @williams2018; @anderson2019synopsis]. 
When the tow-specific value was missing, we applied the mean net opening for that survey. 
These values were used to calculate log area swept in hectares for each tow. 
This was included as an offset term for the positive component of all species distribution models [p.~206, @mccullagh1989].

We fit all spatiotemporal models in R `r getRversion()` with the package sdmTMB [@anderson2024sdmtmb] version `r m$version`. 
Mesh vertices were constrained to be at least 20 km apart, with penalized complexity priors [@fuglstad2019] applied to the covariance parameters assuming a 95% probability that the range was > 20 km and the marginal random field standard deviation was  < 2 in link space. 
Model fit was assessed using randomized quantile residuals [@dunn1996] with fixed effect at their maximum likelihood estimates and random effects taken from a single sample of their approximate distribution [@waagepetersen2006; @thygesen2017]. 
Convergence was determined by checking that the Hessian was positive definite, and that the maximum absolute log likelihood gradient with respect to fixed effects was <0.001. 

From each of these models, we predicted relative biomass for each sampling location and for a 2 x 2 km grid covering the combined domains of the synoptic trawl surveys (Figure \@ref(fig:dens-map-fem) -- \@ref(fig:dens-map-mm)). 
We treated days since summer solstice and survey-catchability effects as catchability covariates (i.e. setting the covariates to reference values to control for them) and bottom depth as a density covariate (i.e. setting the covariate to relevant values for each grid cell). 
Grid values were first used to calculate area-weighted annual indices of relative biomass by summing the predicted biomass each year and applying a generic bias correction for the non-linear transformation of the random effects [@thorson2015; @thorson2016bias]. 
These indices represent expected relative biomass if the entire synoptic survey area was sampled on the summer solstice with synoptic survey catchability. 
We summed the maturity-specific indices in each year to confirm that combined they resulted in the same pattern across years as the index of total biomass (Figure \@ref(fig:dens-indices)).
These predictions also act as covariates and weighting for subsequent condition index generation.

<!-- < fig 3 > -->
```{r dens-map-fem, echo=FALSE, fig.align='center', fig.pos='h', out.width="7in", fig.cap="Predicted mature female biomass density distribution using all catches from surveys with at least 1% positive catches."}
knitr::include_graphics(here::here(paste0("stock-specific/",spp,"/figs/C-density-map-dover-sole-mat-fem-",dens_model_name,"-", knot_distance, "-km.png")))
```

<!-- < fig 4 > -->
```{r dens-map-mm, echo=FALSE, fig.align='center', fig.pos='h', out.width="7in", fig.cap="Predicted mature male biomass density distribution using all catches from surveys with at least 1% positive catches."}
knitr::include_graphics(here::here(paste0("stock-specific/",spp,"/figs/C-density-map-dover-sole-mat-m-",dens_model_name,"-", knot_distance, "-km.png")))
```

<!-- < fig 5 > -->
```{r dens-map-imm, echo=FALSE, fig.align='center', fig.pos='h', out.width="7in", fig.cap="Predicted immature biomass density distribution using all catches from surveys with at least 1% positive catches."}
knitr::include_graphics(here::here(paste0("stock-specific/",spp,"/figs/C-density-map-dover-sole-imm-",dens_model_name,"-", knot_distance, "-km.png")))
```

<!-- < fig 6 > -->
```{r dens-indices, echo=FALSE, fig.align='center', fig.pos='h', out.width="6in", fig.cap="Spatiotemporal model-based biomass index means with 95% CIs for the full combined synoptic survey grid area based on total catches (solid black line and grey shading) and catches split into immature (purple dashed line and shading), mature males (turquoise dashed line and shading), and mature females (yellow dashed line and shading). The sum of the three split indices is indicated by the dotted line, which falls within the CI of the model based on all total catches."}
knitr::include_graphics(here::here(paste0("stock-specific/",spp,"/figs/C-density-indices.png")))
```

\clearpage

## POPULATION INDICES OF LE CREN'S BODY CONDITION

We calculated relative condition factors [$K_\mathrm{rel}$, @lecren1951] as the ratio between the observed weight of an individual fish and the predicted weight. 
The predicted weight was derived from Eq. \@ref(eq:lw) for average species-specific length-weight relationships across years and space, calculated separately for males and females. 
An individual with a $K_\mathrm{rel} = 1$ is in average condition for that species. 
To avoid bias from extreme measurement errors, individuals whose length-weight residuals exceeded $2\times$ the scale parameter for the observation error with a Student t distribution ($df = 3$) were excluded from further analyses (Figure \@ref(fig:lecrens)). 

We then modelled spatiotemporal variation in relative body condition $K_\mathrm{rel}$ separately for each maturity class at each point in space $s$ and time $t$ assuming lognormal observation error 

<!-- < eqn 6 > -->
$$
\begin{aligned}
 \operatorname{K_{rel}} &\sim \operatorname{Lognormal} \left( \operatorname{log} \mu_{3,s,t} - \frac{\vartheta^{2}}{2},\vartheta^2 \right),\\
    \mu_{3,s,t} &= \exp 
    \left(\alpha_{3} + X_{3,s,t} \beta_{3} + \omega_{3,s} + \epsilon_{3,s,t} \right),
\end{aligned}
$$

where $\vartheta$ is the standard deviation in log-space, $\alpha_{3}$ represents the intercept for bottom trawl surveys, $X_{3,s,t}$ represents a vector of predictors (other gear types, and second order polynomial for date relative to the summer solstice), and $\beta_2$ represents a vector of corresponding parameters.
Data from a particular gear type was included in the condition model for each class only when lengths and weights were available for greater than 30 specimens.

Next, we tested for an effect of density-dependence by adding a predictor of estimated log biomass density (combined male and female mature biomass for mature classes, immature estimates otherwise). 
This variable was centered on the average estimated log density for the specimens included in the model. 
When the slope of this density effect was not significantly negative, we reverted to the density-agnostic model of relative body condition. 
When these models did not converge, model simplification involved allowing the spatial and spatiotemporal fields to share the same range parameter, or dropping the spatial field entirely when the spatial random field standard deviation ($\bm{\sigma}_{\omega}$) was less than $0.001$.

From the fitted density-agnostic models for all maturity classes, as well as for any models showing evidence of negative density-dependence, we calculated average Le Cren's condition indices using the same general method as for the biomass indices. 
In this case, local condition estimates (Figure \@ref(fig:cond-map-fem) -- \@ref(fig:cond-map-imm)) were weighted by the proportion of each year's predicted biomass that occurred in each cell (rather than the area of the cell). 
The density-agnostic indices represent the predicted average body condition of an individual fish belonging each maturity class in each year (solid lines in Figure \@ref(fig:cond-indices), while the adjusted indices represent expected average body condition if local biomass density was constant through time at the mean for each cell (dashed lines in Figure \@ref(fig:cond-indices)).
To propagate uncertainty through environmental analyses, we then took 100 samples of this overall condition index by constructing it from 100 samples of the joint parameter precision matrix.

<!-- < fig 7 > -->
```{r lecrens, echo=FALSE, fig.align='center', fig.pos='h', out.width="5in", fig.cap="Le Cren’s relative condition factors (colour scale) for females and males. Red indicates outliers that are assumed to have resulted from extreme measurement error (e.g., data entry errors) and therefore have been excluded from the spatiotemporal model. Vertical lines indicate the maturity thresholds such that samples to the left were included in the immature model and those to the right the mature models."}
knitr::include_graphics(here::here(paste0("stock-specific/",spp,"/figs/C-le-crens.png")))
```

<!-- < fig 8 > -->
```{r cond-map-fem, echo=FALSE, fig.align='center', fig.pos='h', out.width="6.4in", fig.cap="Annual predicted spatial distribution of average mature female body condition factors. Specimen locations are overlaid in red circles sized relative to the number of fish sampled. A black ‘x’ indicates a location where the species was caught, but no morphological data were collected."}
knitr::include_graphics(here::here(paste0("stock-specific/",spp,"/figs/C-condition-map-",spp,"-Mature-females-",model_date,"-", knot_distance, "-km.png")))
```

<!-- < fig 9 > -->
```{r cond-map-mm, echo=FALSE, fig.align='center', fig.pos='h', out.width="6.4in", fig.cap="Annual predicted spatial distribution of average mature male body condition factors. Because density-dependence was negative, these predictions assume local biomass density was constant through time at the mean for each cell. Specimen locations are overlaid in red circles sized relative to the number of fish sampled. A black ‘x’ indicates a location where the species was caught, but no morphological data were collected."}
knitr::include_graphics(here::here(paste0("stock-specific/",spp,"/figs/C-condition-map-",spp,"-Mature-males-",model_date,"-", knot_distance, "-km.png")))
```

<!-- < fig 10 > -->
```{r cond-map-imm, echo=FALSE, fig.align='center', fig.pos='h', out.width="6.4in", fig.cap="Annual predicted spatial distribution of average immature body condition factors. Specimen locations are overlaid in red circles sized relative to the number of fish sampled. A black ‘x’ indicates a location where the species was caught, but no morphological data were collected."}
knitr::include_graphics(here::here(paste0("stock-specific/",spp,"/figs/C-condition-map-",spp,"-Immature-",model_date,"-", knot_distance, "-km.png")))
```

## For Results section of assessment

### Body condition indices
<!-- Describe the indices -->
Indices of average body condition...  (Figure \@ref(fig:cond-indices)A). 
<!-- Does any class show greater inter-annual variability than the others?  -->
<!-- Does any class show any statistical evidence of negative density-dependence in the spatial condition models and therefore have this effect removed before testing for environmental correlates of body condition? -->
<!-- Describe differences between regions -->
Splitting these indices by synoptic trawl survey area suggests that ... (Figure \@ref(fig:cond-indices)B).

```{r cond-indices, echo=FALSE, fig.align='center', fig.pos='h', out.width="5.5in", fig.cap="Annual average body condition deviations for immatures (purple), mature males (turquoise), and mature females (yellow) estimated for the summer solstice in all areas sampled by synoptic trawl surveys using a spatiotemporal model. Solid lines represent modelled population predictions, while dashed lines represent the average condition adjusted to exclude any estimated negative effects of local biomass density. All variables have been standardized within the time period tested, so an estimate of 1 for the linear component means that 1 SD in that variable is predicted to increase body condition by 1 SD."}
knitr::include_graphics(here::here(paste0("stock-specific/",spp,"/figs/C-00-",spp,"-all-condition-indices-w-split-",model_date,"-ld0c.png")))
```

## References
